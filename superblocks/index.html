<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Auth0 Test - Superblocks</title>
    <script src="https://cdn.auth0.com/js/auth0-spa-js/2.0/auth0-spa-js.production.js"></script>
    <style>
      body {
        font-family: Arial, sans-serif;
        padding: 20px;
      }
      .info {
        background: #e3f2fd;
        padding: 15px;
        margin: 10px 0;
        border-radius: 5px;
      }
      .error {
        background: #ffebee;
        padding: 15px;
        margin: 10px 0;
        border-radius: 5px;
        color: #c62828;
      }
      .success {
        background: #e8f5e8;
        padding: 15px;
        margin: 10px 0;
        border-radius: 5px;
        color: #2e7d32;
      }
      button {
        padding: 10px 20px;
        margin: 5px;
        cursor: pointer;
      }
      pre {
        background: #f5f5f5;
        padding: 10px;
        overflow-x: auto;
      }
    </style>
  </head>
  <body>
    <h1>Auth0 Configuration Test</h1>

    <div class="info">
      <h3>Current Configuration:</h3>
      <p><strong>Domain:</strong> dev-ajpiv5ho3pze4hxh.us.auth0.com</p>
      <p><strong>Client ID:</strong> uMxwqgmOfAgt60Dqym3hMM331iAgh2A2</p>
      <p><strong>Current URL:</strong> <span id="currentUrl"></span></p>
      <p>
        <strong>Expected Redirect URI:</strong> <span id="redirectUri"></span>
      </p>
    </div>

    <div id="status"></div>

    <div id="controls">
      <button onclick="testLogin()">Test Auth0 Login</button>
      <button onclick="checkAuth()">Check Authentication Status</button>
      <button onclick="clearStorage()">Clear Storage & Reload</button>
    </div>

    <div id="logs">
      <h3>Debug Logs:</h3>
      <pre id="logOutput"></pre>
    </div>

    <script>
      const currentUrl = window.location.href;
      const redirectUri = currentUrl;

      document.getElementById("currentUrl").textContent = currentUrl;
      document.getElementById("redirectUri").textContent = redirectUri;

      const config = {
        domain: "dev-ajpiv5ho3pze4hxh.us.auth0.com",
        clientId: "uMxwqgmOfAgt60Dqym3hMM331iAgh2A2",
        audience: "onboard-app",
        redirectUri: redirectUri,
      };

      let auth0Client;
      let logs = [];

      function addLog(message, type = "info") {
        const timestamp = new Date().toLocaleTimeString();
        logs.push(`[${timestamp}] ${type.toUpperCase()}: ${message}`);
        document.getElementById("logOutput").textContent = logs.join("\n");
        console.log(`[Auth0 Test] ${message}`);
      }

      async function initAuth0() {
        try {
          addLog("Initializing Auth0 client...");

          auth0Client = await auth0.createAuth0Client({
            domain: config.domain,
            clientId: config.clientId,
            authorizationParams: {
              audience: config.audience,
              redirect_uri: config.redirectUri,
            },
            cacheLocation: "localstorage",
          });

          addLog("Auth0 client initialized successfully");

          // Check for callback
          if (
            window.location.search.includes("code=") ||
            window.location.search.includes("error=")
          ) {
            addLog("Detected Auth0 callback, processing...");
            try {
              const result = await auth0Client.handleRedirectCallback();
              addLog(
                `Callback processed successfully: ${JSON.stringify(result)}`,
                "success"
              );

              // Clean URL
              window.history.replaceState(
                {},
                document.title,
                window.location.pathname
              );

              // Check auth status
              await checkAuth();
            } catch (error) {
              addLog(`Callback error: ${error.message}`, "error");
              document.getElementById("status").innerHTML = `
                            <div class="error">
                                <h3>Callback Error:</h3>
                                <p>${error.message}</p>
                                <p><strong>Full error:</strong></p>
                                <pre>${JSON.stringify(error, null, 2)}</pre>
                            </div>
                        `;
            }
          } else {
            await checkAuth();
          }
        } catch (error) {
          addLog(`Auth0 initialization failed: ${error.message}`, "error");
          document.getElementById("status").innerHTML = `
                    <div class="error">
                        <h3>Initialization Error:</h3>
                        <p>${error.message}</p>
                        <h4>Common causes:</h4>
                        <ul>
                            <li>Wrong domain or client ID</li>
                            <li>Missing redirect URI in Auth0 dashboard</li>
                            <li>CORS issues</li>
                        </ul>
                        <p><strong>Add this URL to Auth0 Allowed Callback URLs:</strong></p>
                        <code>${config.redirectUri}</code>
                    </div>
                `;
        }
      }

      async function checkAuth() {
        try {
          if (!auth0Client) {
            addLog("Auth0 client not initialized");
            return;
          }

          const isAuthenticated = await auth0Client.isAuthenticated();
          addLog(`Authentication status: ${isAuthenticated}`);

          if (isAuthenticated) {
            const user = await auth0Client.getUser();
            addLog(`User authenticated: ${user.email || user.name}`);

            document.getElementById("status").innerHTML = `
                        <div class="success">
                            <h3>✅ Authentication Successful!</h3>
                            <p><strong>User:</strong> ${
                              user.name || user.email
                            }</p>
                            <p><strong>User ID:</strong> ${user.sub}</p>
                            <button onclick="testSuperblocksToken()">Test Superblocks Token</button>
                            <button onclick="logout()">Logout</button>
                        </div>
                    `;
          } else {
            document.getElementById("status").innerHTML = `
                        <div class="info">
                            <h3>Not Authenticated</h3>
                            <p>Click "Test Auth0 Login" to authenticate</p>
                        </div>
                    `;
          }
        } catch (error) {
          addLog(`Error checking auth: ${error.message}`, "error");
        }
      }

      async function testLogin() {
        try {
          addLog("Starting login process...");
          addLog(`Redirect URI: ${config.redirectUri}`);

          await auth0Client.loginWithRedirect({
            authorizationParams: {
              redirect_uri: config.redirectUri,
            },
          });
        } catch (error) {
          addLog(`Login error: ${error.message}`, "error");
        }
      }

      async function testSuperblocksToken() {
        try {
          addLog("Getting Auth0 token...");

          const token = await auth0Client.getTokenSilently({
            authorizationParams: {
              audience: config.audience,
            },
          });

          addLog(`Got Auth0 token: ${token.substring(0, 50)}...`);

          addLog("Calling Superblocks API...");
          const response = await fetch(
            "http://localhost:3001/api/superblocks/token",
            {
              headers: {
                Authorization: `Bearer ${token}`,
                "Content-Type": "application/json",
              },
            }
          );

          addLog(`Superblocks API status: ${response.status}`);

          if (response.ok) {
            const data = await response.json();
            addLog(
              `Superblocks token received: ${data.access_token.substring(
                0,
                50
              )}...`,
              "success"
            );

            document.getElementById("status").innerHTML += `
                        <div class="success">
                            <h4>✅ Superblocks Token Success!</h4>
                            <p>Ready to embed Superblocks app</p>
                        </div>
                    `;
          } else {
            const errorText = await response.text();
            addLog(`Superblocks API error: ${errorText}`, "error");
          }
        } catch (error) {
          addLog(`Superblocks token error: ${error.message}`, "error");
        }
      }

      async function logout() {
        try {
          await auth0Client.logout({
            returnTo: config.redirectUri,
          });
        } catch (error) {
          addLog(`Logout error: ${error.message}`, "error");
        }
      }

      function clearStorage() {
        localStorage.clear();
        sessionStorage.clear();
        addLog("Storage cleared, reloading...");
        window.location.reload();
      }

      // Initialize when page loads
      initAuth0();
    </script>
  </body>
</html>
