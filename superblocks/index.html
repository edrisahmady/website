<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Superblocks Embed - edrisahmady.com</title>
    <script src="https://cdn.auth0.com/js/auth0-spa-js/2.0/auth0-spa-js.production.js"></script>
    <style>
      body {
        font-family: Arial, sans-serif;
        margin: 0;
        padding: 0;
      }
      .header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 10px 20px;
        border-bottom: 1px solid #eee;
      }
      .login-container {
        text-align: center;
        padding: 50px;
      }
      .button {
        padding: 10px 20px;
        font-size: 16px;
        border: none;
        border-radius: 5px;
        cursor: pointer;
      }
      .primary {
        background-color: #007bff;
        color: white;
      }
      .danger {
        background-color: #dc3545;
        color: white;
        padding: 5px 10px;
        font-size: 14px;
      }
      .loading {
        text-align: center;
        padding: 20px;
      }
      .error {
        color: red;
        padding: 20px;
      }
      .embed-container {
        padding: 20px;
      }
    </style>
  </head>
  <body>
    <div id="app">
      <div class="loading">Loading...</div>
    </div>

    <script>
      // Environment configuration - UPDATED WITH YOUR REAL CREDENTIALS
      const config = {
        auth0Domain: "dev-ajpiv5ho3pze4hxh.us.auth0.com",
        auth0ClientId: "uMxwqgmOfAgt60Dqym3hMM331iAgh2A2",
        auth0Audience: "onboard-app",
        apiUrl: "http://localhost:3001", // Your server URL
      };

      let auth0Client;
      let superblocksToken = null;

      async function initAuth0() {
        try {
          auth0Client = await auth0.createAuth0Client({
            domain: config.auth0Domain,
            clientId: config.auth0ClientId,
            authorizationParams: {
              audience: config.auth0Audience,
            },
            cacheLocation: "localstorage",
          });

          // Handle redirect callback
          if (
            location.search.includes("code=") ||
            location.search.includes("error=")
          ) {
            await auth0Client.handleRedirectCallback();
            window.history.replaceState({}, document.title, "/");
          }

          await updateUI();
        } catch (error) {
          console.error("Auth0 initialization error:", error);
          document.getElementById("app").innerHTML = `
                    <div class="error">Authentication initialization failed: ${error.message}</div>
                `;
        }
      }

      async function updateUI() {
        const isAuthenticated = await auth0Client.isAuthenticated();

        if (!isAuthenticated) {
          document.getElementById("app").innerHTML = `
                    <div class="login-container">
                        <h2>Please log in to access the application</h2>
                        <button class="button primary" onclick="login()">Log In</button>
                    </div>
                `;
          return;
        }

        const user = await auth0Client.getUser();

        document.getElementById("app").innerHTML = `
                <div class="header">
                    <div>Welcome, ${user.name || user.email}!</div>
                    <button class="button danger" onclick="logout()">Log Out</button>
                </div>
                <div id="content">
                    <div class="loading">Loading Superblocks...</div>
                </div>
            `;

        // Get Superblocks token
        await getSuperblocks();
      }

      async function getSuperblocks() {
        try {
          const token = await auth0Client.getTokenSilently({
            authorizationParams: {
              audience: config.auth0Audience,
            },
          });

          const response = await fetch(
            `${config.apiUrl}/api/superblocks/token`,
            {
              headers: {
                Authorization: `Bearer ${token}`,
                "Content-Type": "application/json",
              },
            }
          );

          if (!response.ok) {
            const errorData = await response.text();
            throw new Error(
              `HTTP error! status: ${response.status}, message: ${errorData}`
            );
          }

          const data = await response.json();
          superblocksToken = data;

          console.log("Superblocks token received:", data);

          // FIXED: Use access_token instead of token (based on your server response)
          loadSuperblocksEmbed(data.access_token);
        } catch (error) {
          console.error("Error getting Superblocks token:", error);
          document.getElementById("content").innerHTML = `
                    <div class="error">
                        Error loading application: ${error.message}
                        <br><button onclick="getSuperblocks()">Retry</button>
                    </div>
                `;
        }
      }

      function login() {
        auth0Client.loginWithRedirect();
      }

      function logout() {
        auth0Client.logout({
          returnTo: window.location.origin,
        });
      }

      function loadSuperblocksEmbed(token) {
        // Clear content
        document.getElementById("content").innerHTML = `
                <div class="embed-container">
                    <h3>Superblocks Application</h3>
                    <div id="superblocks-container"></div>
                </div>
            `;

        // Check if Superblocks script is already loaded
        if (!window.Superblocks) {
          const script = document.createElement("script");
          script.src =
            "https://prod-cdn.superblocks.com/packages/@superblocksteam/embed@latest/embed.bundle.js";
          script.onload = () => createSuperblocksApp(token);
          script.onerror = () => {
            document.getElementById("content").innerHTML = `
                        <div class="error">Failed to load Superblocks embed script</div>
                    `;
          };
          document.head.appendChild(script);
        } else {
          createSuperblocksApp(token);
        }
      }

      function createSuperblocksApp(token) {
        try {
          console.log("Creating Superblocks app with token:", token);

          const sbApp = Superblocks.createSuperblocksEmbed({
            src: "https://app.superblocks.com/embed/applications/6e427632-7ba5-45b4-acfb-d83b48cc71c4",
            // FIXED: Pass the authentication token to Superblocks
            authToken: token,
            // You can also pass other properties here
            // properties: { EmbedProp1: "Hello World" }
          });

          // Append to the container instead of body
          const container = document.getElementById("superblocks-container");
          if (container) {
            container.appendChild(sbApp);
            console.log("Superblocks app successfully embedded");
          } else {
            console.error("Superblocks container not found");
          }
        } catch (error) {
          console.error("Error creating Superblocks app:", error);
          document.getElementById("content").innerHTML = `
                    <div class="error">Error loading Superblocks application: ${error.message}</div>
                `;
        }
      }

      // Initialize when page loads
      initAuth0();
    </script>
  </body>
</html>
