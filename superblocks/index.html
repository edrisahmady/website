<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Superblocks Embed - edrisahmady.com</title>
    <script src="https://cdn.auth0.com/js/auth0-spa-js/2.0/auth0-spa-js.production.js"></script>
    <style>
      body {
        font-family: Arial, sans-serif;
        margin: 0;
        padding: 0;
      }
      .header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 10px 20px;
        border-bottom: 1px solid #eee;
      }
      .login-container {
        text-align: center;
        padding: 50px;
      }
      .button {
        padding: 10px 20px;
        font-size: 16px;
        border: none;
        border-radius: 5px;
        cursor: pointer;
      }
      .primary {
        background-color: #007bff;
        color: white;
      }
      .danger {
        background-color: #dc3545;
        color: white;
        padding: 5px 10px;
        font-size: 14px;
      }
      .loading {
        text-align: center;
        padding: 20px;
      }
      .error {
        color: red;
        padding: 20px;
      }
      .debug {
        background-color: #f8f9fa;
        border: 1px solid #dee2e6;
        padding: 10px;
        margin: 10px;
        font-family: monospace;
        font-size: 12px;
      }
      .embed-container {
        padding: 20px;
      }
    </style>
  </head>
  <body>
    <div id="app">
      <div class="loading">Loading...</div>
    </div>

    <!-- Debug Information -->
    <div class="debug">
      <h4>Debug Information:</h4>
      <p><strong>Current URL:</strong> <span id="currentUrl"></span></p>
      <p><strong>Origin:</strong> <span id="origin"></span></p>
      <p><strong>Full Path:</strong> <span id="fullPath"></span></p>
      <p><strong>Redirect URI:</strong> <span id="redirectUri"></span></p>
    </div>

    <script>
      // Display debug info
      const currentUrl = window.location.href;
      const origin = window.location.origin;
      const fullPath = window.location.pathname;
      // Ensure trailing slash for consistency
      const redirectUri = currentUrl.endsWith("/")
        ? currentUrl
        : currentUrl + "/";

      document.getElementById("currentUrl").textContent = currentUrl;
      document.getElementById("origin").textContent = origin;
      document.getElementById("fullPath").textContent = fullPath;
      document.getElementById("redirectUri").textContent = redirectUri;

      // Environment configuration
      const config = {
        auth0Domain: "dev-ajpiv5ho3pze4hxh.us.auth0.com",
        auth0ClientId: "uMxwqgmOfAgt60Dqym3hMM331iAgh2A2",
        auth0Audience: "onboard-app",
        apiUrl: "http://localhost:3001", // Your server URL
        redirectUri: redirectUri, // Use current full URL
      };

      console.log("Config:", config);
      console.log("Current URL:", currentUrl);
      console.log("Redirect URI:", redirectUri);

      let auth0Client;
      let superblocksToken = null;

      async function initAuth0() {
        try {
          console.log("Initializing Auth0...");

          auth0Client = await auth0.createAuth0Client({
            domain: config.auth0Domain,
            clientId: config.auth0ClientId,
            authorizationParams: {
              audience: config.auth0Audience,
              redirect_uri: config.redirectUri, // Use full URL including /superblocks
            },
            cacheLocation: "localstorage",
          });

          console.log("Auth0 client created successfully");

          // Handle redirect callback
          if (
            location.search.includes("code=") ||
            location.search.includes("error=")
          ) {
            console.log("Handling redirect callback...");
            try {
              const result = await auth0Client.handleRedirectCallback();
              console.log("Redirect callback result:", result);
              // Clean URL but preserve the trailing slash
              const cleanPath = window.location.pathname.endsWith("/")
                ? window.location.pathname
                : window.location.pathname + "/";
              window.history.replaceState({}, document.title, cleanPath);
            } catch (callbackError) {
              console.error("Callback error:", callbackError);
              document.getElementById("app").innerHTML = `
                <div class="error">
                  Callback error: ${callbackError.message}
                  <br><br>
                  <strong>Error details:</strong> ${JSON.stringify(
                    callbackError,
                    null,
                    2
                  )}
                  <br><br>
                  <strong>Current URL:</strong> ${currentUrl}
                  <br>
                  <strong>Expected in Auth0:</strong> ${config.redirectUri}
                </div>
              `;
              return;
            }
          }

          await updateUI();
        } catch (error) {
          console.error("Auth0 initialization error:", error);
          document.getElementById("app").innerHTML = `
            <div class="error">
              Authentication initialization failed: ${error.message}
              <br><br>
              <strong>Error details:</strong> ${JSON.stringify(error, null, 2)}
              <br><br>
              <strong>Current URL:</strong> ${currentUrl}
              <br>
              <strong>Redirect URI:</strong> ${config.redirectUri}
              <br>
              <strong>Action needed:</strong> Add "${
                config.redirectUri
              }" to Auth0 Allowed Callback URLs
            </div>
          `;
        }
      }

      async function updateUI() {
        try {
          console.log("Updating UI...");
          const isAuthenticated = await auth0Client.isAuthenticated();
          console.log("Is authenticated:", isAuthenticated);

          if (!isAuthenticated) {
            document.getElementById("app").innerHTML = `
              <div class="login-container">
                <h2>Please log in to access the application</h2>
                <p><strong>Current path:</strong> ${fullPath}</p>
                <p><strong>Redirect URI:</strong> ${config.redirectUri}</p>
                <button class="button primary" onclick="login()">Log In</button>
              </div>
            `;
            return;
          }

          const user = await auth0Client.getUser();
          console.log("User:", user);

          document.getElementById("app").innerHTML = `
            <div class="header">
              <div>Welcome, ${user.name || user.email}!</div>
              <button class="button danger" onclick="logout()">Log Out</button>
            </div>
            <div id="content">
              <div class="loading">Loading Superblocks...</div>
            </div>
          `;

          // Get Superblocks token
          await getSuperblocks();
        } catch (error) {
          console.error("Error updating UI:", error);
          document.getElementById("app").innerHTML = `
            <div class="error">Error updating UI: ${error.message}</div>
          `;
        }
      }

      async function getSuperblocks() {
        try {
          console.log("Getting Superblocks token...");

          const token = await auth0Client.getTokenSilently({
            authorizationParams: {
              audience: config.auth0Audience,
            },
          });

          console.log("Got Auth0 token:", token.substring(0, 20) + "...");

          const response = await fetch(
            `${config.apiUrl}/api/superblocks/token`,
            {
              headers: {
                Authorization: `Bearer ${token}`,
                "Content-Type": "application/json",
              },
            }
          );

          console.log("Superblocks API response status:", response.status);

          if (!response.ok) {
            const errorData = await response.text();
            throw new Error(
              `HTTP error! status: ${response.status}, message: ${errorData}`
            );
          }

          const data = await response.json();
          superblocksToken = data;

          console.log("Superblocks token received:", data);

          loadSuperblocksEmbed(data.access_token);
        } catch (error) {
          console.error("Error getting Superblocks token:", error);
          document.getElementById("content").innerHTML = `
            <div class="error">
              Error loading application: ${error.message}
              <br><button onclick="getSuperblocks()">Retry</button>
            </div>
          `;
        }
      }

      function login() {
        console.log("Starting login...");
        console.log("Redirect URI will be:", config.redirectUri);

        auth0Client.loginWithRedirect({
          authorizationParams: {
            redirect_uri: config.redirectUri,
          },
        });
      }

      function logout() {
        auth0Client.logout({
          returnTo: config.redirectUri,
        });
      }

      function loadSuperblocksEmbed(token) {
        // Clear content
        document.getElementById("content").innerHTML = `
          <div class="embed-container">
            <h3>Superblocks Application</h3>
            <div id="superblocks-container"></div>
          </div>
        `;

        // Check if Superblocks script is already loaded
        if (!window.Superblocks) {
          const script = document.createElement("script");
          script.src =
            "https://prod-cdn.superblocks.com/packages/@superblocksteam/embed@latest/embed.bundle.js";
          script.onload = () => createSuperblocksApp(token);
          script.onerror = () => {
            document.getElementById("content").innerHTML = `
              <div class="error">Failed to load Superblocks embed script</div>
            `;
          };
          document.head.appendChild(script);
        } else {
          createSuperblocksApp(token);
        }
      }

      function createSuperblocksApp(token) {
        try {
          console.log("Creating Superblocks app with token:", token);

          const sbApp = Superblocks.createSuperblocksEmbed({
            src: "https://app.superblocks.com/embed/applications/6e427632-7ba5-45b4-acfb-d83b48cc71c4",
            authToken: token,
          });

          const container = document.getElementById("superblocks-container");
          if (container) {
            container.appendChild(sbApp);
            console.log("Superblocks app successfully embedded");
          } else {
            console.error("Superblocks container not found");
          }
        } catch (error) {
          console.error("Error creating Superblocks app:", error);
          document.getElementById("content").innerHTML = `
            <div class="error">Error loading Superblocks application: ${error.message}</div>
          `;
        }
      }

      // Initialize when page loads
      initAuth0();
    </script>
  </body>
</html>
