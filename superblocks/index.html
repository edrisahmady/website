<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Superblocks Application</title>
    <script src="https://cdn.auth0.com/js/auth0-spa-js/2.0/auth0-spa-js.production.js"></script>
    <style>
      body {
        font-family: Arial, sans-serif;
        margin: 0;
        padding: 0;
        background-color: #f5f5f5;
      }
      .header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 15px 30px;
        background: white;
        border-bottom: 1px solid #e0e0e0;
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
      }
      .logo {
        font-size: 24px;
        font-weight: bold;
        color: #333;
      }
      .user-info {
        display: flex;
        align-items: center;
        gap: 15px;
      }
      .login-container {
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        min-height: 100vh;
        text-align: center;
        padding: 20px;
      }
      .login-card {
        background: white;
        padding: 40px;
        border-radius: 8px;
        box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        max-width: 400px;
        width: 100%;
      }
      .button {
        padding: 12px 24px;
        font-size: 16px;
        border: none;
        border-radius: 5px;
        cursor: pointer;
        transition: background-color 0.2s;
        margin: 5px;
      }
      .primary {
        background-color: #007bff;
        color: white;
      }
      .primary:hover {
        background-color: #0056b3;
      }
      .secondary {
        background-color: #6c757d;
        color: white;
        padding: 8px 16px;
        font-size: 14px;
      }
      .secondary:hover {
        background-color: #545b62;
      }
      .loading {
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        min-height: 80vh;
        text-align: center;
      }
      .spinner {
        border: 4px solid #f3f3f3;
        border-top: 4px solid #007bff;
        border-radius: 50%;
        width: 40px;
        height: 40px;
        animation: spin 1s linear infinite;
        margin-bottom: 20px;
      }
      @keyframes spin {
        0% {
          transform: rotate(0deg);
        }
        100% {
          transform: rotate(360deg);
        }
      }
      .error {
        background: #f8d7da;
        color: #721c24;
        padding: 15px;
        margin: 20px;
        border-radius: 5px;
        border: 1px solid #f5c6cb;
      }
      .debug-info {
        background: #d1ecf1;
        color: #0c5460;
        padding: 10px;
        margin: 10px 0;
        border-radius: 5px;
        font-family: monospace;
        font-size: 12px;
        text-align: left;
      }
      .superblocks-container {
        width: 100%;
        min-height: calc(100vh - 80px);
        background: white;
      }
      .app-container {
        background: white;
        min-height: calc(100vh - 80px);
      }
    </style>
  </head>
  <body>
    <div id="app">
      <div class="loading">
        <div class="spinner"></div>
        <p>Loading application...</p>
      </div>
    </div>

    <script>
      const config = {
        auth0Domain: "dev-ajpiv5ho3pze4hxh.us.auth0.com",
        auth0ClientId: "uMxwqgmOfAgt60Dqym3hMM331iAgh2A2",
        auth0Audience: "onboard-app",
        // UPDATE THIS WITH YOUR CURRENT NGROK URL
        apiUrl: "https://a69d93278d87.ngrok-free.app",
        redirectUri: window.location.href,
      };

      let auth0Client;
      let superblocksToken = null;

      async function initAuth0() {
        try {
          console.log("Initializing Auth0...");
          console.log("API URL:", config.apiUrl);

          auth0Client = await auth0.createAuth0Client({
            domain: config.auth0Domain,
            clientId: config.auth0ClientId,
            authorizationParams: {
              audience: config.auth0Audience,
              redirect_uri: config.redirectUri,
            },
            cacheLocation: "localstorage",
          });

          console.log("Auth0 client initialized");

          // Handle redirect callback
          if (
            window.location.search.includes("code=") ||
            window.location.search.includes("error=")
          ) {
            console.log("Processing Auth0 callback...");

            try {
              await auth0Client.handleRedirectCallback();
              window.history.replaceState(
                {},
                document.title,
                window.location.pathname
              );
              console.log("Callback processed successfully");
            } catch (error) {
              console.error("Callback error:", error);
              showError("Authentication failed", error.message);
              return;
            }
          }

          await updateUI();
        } catch (error) {
          console.error("Auth0 initialization error:", error);
          showError("Authentication system error", error.message);
        }
      }

      async function updateUI() {
        try {
          const isAuthenticated = await auth0Client.isAuthenticated();
          console.log("Authentication status:", isAuthenticated);

          if (!isAuthenticated) {
            showLogin();
            return;
          }

          const user = await auth0Client.getUser();
          console.log("User authenticated:", user.email || user.name);

          // Show header with user info
          document.getElementById("app").innerHTML = `
            <div class="header">
              <div class="logo">Superblocks Application</div>
              <div class="user-info">
                <span>Welcome, ${user.name || user.email}!</span>
                <button class="button secondary" onclick="logout()">Logout</button>
              </div>
            </div>
            <div class="app-container">
              <div class="loading">
                <div class="spinner"></div>
                <p>Loading your application...</p>
                <div class="debug-info">
                  Current API URL: ${config.apiUrl}<br>
                  Testing connection...
                </div>
              </div>
            </div>
          `;

          // Get Superblocks token and load app
          await loadSuperblocksApp();
        } catch (error) {
          console.error("Error updating UI:", error);
          showError("Application error", error.message);
        }
      }

      function showLogin() {
        document.getElementById("app").innerHTML = `
          <div class="login-container">
            <div class="login-card">
              <h1>Welcome</h1>
              <p>Please log in to access your application</p>
              <div class="debug-info">
                API URL: ${config.apiUrl}
              </div>
              <button class="button primary" onclick="login()">Log In</button>
            </div>
          </div>
        `;
      }

      function showError(title, message) {
        document.getElementById("app").innerHTML = `
          <div class="login-container">
            <div class="login-card">
              <div class="error">
                <h3>${title}</h3>
                <p>${message}</p>
                <div class="debug-info">
                  Current API URL: ${config.apiUrl}<br>
                  Check if ngrok is running and URL is correct
                </div>
                <button class="button primary" onclick="window.location.reload()">Retry</button>
                <button class="button secondary" onclick="testConnection()">Test API Connection</button>
              </div>
            </div>
          </div>
        `;
      }

      async function testConnection() {
        try {
          console.log("Testing API connection to:", config.apiUrl);
          const response = await fetch(`${config.apiUrl}/health`, {
            headers: {
              "ngrok-skip-browser-warning": "true",
            },
          });

          if (response.ok) {
            const data = await response.json();
            alert(
              `✅ API Connection Success!\nStatus: ${data.status}\nServer: ${data.auth0Domain}`
            );
          } else {
            alert(`❌ API Connection Failed!\nStatus: ${response.status}`);
          }
        } catch (error) {
          alert(
            `❌ API Connection Error!\n${error.message}\n\nCheck if:\n1. ngrok is running\n2. Server is running\n3. URL is correct`
          );
        }
      }

      async function loadSuperblocksApp() {
        try {
          console.log("Getting Superblocks token...");

          const token = await auth0Client.getTokenSilently({
            authorizationParams: {
              audience: config.auth0Audience,
            },
          });

          console.log("Auth0 token obtained, calling API...");

          const response = await fetch(
            `${config.apiUrl}/api/superblocks/token`,
            {
              headers: {
                Authorization: `Bearer ${token}`,
                "Content-Type": "application/json",
                "ngrok-skip-browser-warning": "true",
              },
            }
          );

          if (!response.ok) {
            const errorText = await response.text();
            throw new Error(`Server error: ${response.status} - ${errorText}`);
          }

          const data = await response.json();
          superblocksToken = data.access_token;

          console.log(
            "Superblocks token received:",
            superblocksToken ? "Yes" : "No"
          );
          console.log(
            "Token length:",
            superblocksToken ? superblocksToken.length : "N/A"
          );

          // Load Superblocks embed
          await loadSuperblocksEmbed();
        } catch (error) {
          console.error("Error loading Superblocks app:", error);
          showError(
            "Failed to load application",
            `${error.message}\n\nThis usually means:\n1. ngrok URL changed\n2. Server is not running\n3. Network connectivity issue`
          );
        }
      }

      async function loadSuperblocksEmbed() {
        try {
          // Load Superblocks script if not already loaded
          if (!window.Superblocks) {
            console.log("Loading Superblocks embed script...");

            await new Promise((resolve, reject) => {
              const script = document.createElement("script");
              script.src =
                "https://prod-cdn.superblocks.com/packages/@superblocksteam/embed@latest/embed.bundle.js";
              script.onload = resolve;
              script.onerror = () =>
                reject(new Error("Failed to load Superblocks embed script"));
              document.head.appendChild(script);
            });
          }

          console.log("Creating Superblocks app...");

          // Try different token parameter names based on Superblocks documentation
          const embedConfig = {
            src: "https://app.superblocks.com/embed/applications/6e427632-7ba5-45b4-acfb-d83b48cc71c4",
            token: superblocksToken, // Primary method per docs
          };

          console.log("Embed config:", embedConfig);

          const sbApp = Superblocks.createSuperblocksEmbed(embedConfig);

          // Replace the loading content with the Superblocks app
          const appContainer = document.querySelector(".app-container");
          if (appContainer) {
            appContainer.innerHTML =
              '<div class="superblocks-container"></div>';
            const container = document.querySelector(".superblocks-container");
            container.appendChild(sbApp);
            console.log("Superblocks app loaded successfully");
          } else {
            throw new Error("App container not found");
          }
        } catch (error) {
          console.error("Error loading Superblocks embed:", error);
          showError("Failed to load Superblocks application", error.message);
        }
      }

      function login() {
        console.log("Starting login...");
        auth0Client.loginWithRedirect({
          authorizationParams: {
            redirect_uri: config.redirectUri,
          },
        });
      }

      function logout() {
        auth0Client.logout({
          returnTo: config.redirectUri,
        });
      }

      // Initialize when page loads
      initAuth0();
    </script>
  </body>
</html>
